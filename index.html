<html class="scroll-smooth" lang="es">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   MyHorizon - Portal Futurista
  </title>
  <script src="https://cdn.tailwindcss.com">
  </script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&amp;display=swap" rel="stylesheet"/>
  <style>
   :root {
    --color-bg: #121212;
    --color-bg-alt: #1a1a1a;
    --color-orange: #ff6a00;
    --color-orange-intense: #ff8c00;
    --color-text: #e0e0e0;
    --color-text-muted: #a0a0a0;
    --color-shadow: rgba(255, 106, 0, 0.3);
  }
  html, body {
    font-family: 'Montserrat', sans-serif;
    background-color: var(--color-bg);
    color: var(--color-text);
    scroll-behavior: smooth;
  }
  /* Scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-track {
    background: var(--color-bg);
  }
  ::-webkit-scrollbar-thumb {
    background-color: var(--color-orange);
    border-radius: 10px;
  }
  /* Orange glowing button */
  .btn-orange {
    background-color: var(--color-orange);
    color: var(--color-bg);
    font-weight: 700;
    transition: box-shadow 0.3s ease;
  }
  .btn-orange:hover, .btn-orange:focus {
    box-shadow: 0 0 12px var(--color-orange);
    outline: none;
  }
  /* Orange glowing icon */
  .icon-orange {
    color: var(--color-orange);
    transition: color 0.3s ease, text-shadow 0.3s ease;
  }
  .icon-orange:hover, .icon-orange:focus {
    color: var(--color-orange-intense);
    text-shadow: 0 0 8px var(--color-orange-intense);
    outline: none;
  }
  /* Smooth transitions for interactive elements */
  .transition-smooth {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  /* Parallax container */
  .parallax {
    perspective: 1000px;
  }
  /* Morphing shapes */
  .morph-shape {
    transition: border-radius 0.6s ease-in-out;
  }
  .morph-shape:hover {
    border-radius: 40% 60% 70% 30% / 30% 40% 60% 70%;
  }
  /* Holographic loading */
  @keyframes holographicPulse {
    0%, 100% {
      box-shadow: 0 0 8px var(--color-orange), 0 0 20px var(--color-orange);
    }
    50% {
      box-shadow: 0 0 20px var(--color-orange-intense), 0 0 40px var(--color-orange-intense);
    }
  }
  .holo-loading {
    animation: holographicPulse 2.5s infinite ease-in-out;
  }
  /* Wave light effect */
  @keyframes waveLight {
    0% {
      box-shadow: 0 0 0 0 var(--color-orange);
    }
    100% {
      box-shadow: 0 0 20px 10px transparent;
    }
  }
  .wave-light {
    animation: waveLight 1.5s ease-out forwards;
  }
  /* Focus mode background subtle animation */
  @keyframes focusBgAnim {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  .focus-bg {
    background: linear-gradient(270deg, #1a1a1a, #222222, #1a1a1a);
    background-size: 600% 600%;
    animation: focusBgAnim 30s ease infinite;
  }
  /* Accessibility focus outline */
  :focus-visible {
    outline: 2px solid var(--color-orange);
    outline-offset: 2px;
  }
  /* Liquid ink effect for drawings */
  .liquid-ink {
    stroke: var(--color-orange);
    stroke-width: 2;
    fill: none;
    filter: drop-shadow(0 0 2px var(--color-orange));
  }
  /* Tooltip */
  .tooltip {
    position: relative;
    cursor: help;
  }
  .tooltip:hover .tooltip-text, .tooltip:focus-within .tooltip-text {
    opacity: 1;
    visibility: visible;
  }
  .tooltip-text {
    position: absolute;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--color-orange);
    color: var(--color-bg);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
    z-index: 50;
  }
  </style>
 </head>
 <body class="relative min-h-screen flex flex-col">
  <!-- Side Panel for Settings and Quick Config -->
  <aside aria-label="Panel de configuración rápida" class="fixed top-0 right-0 h-full w-80 max-w-full bg-[#1a1a1a] shadow-lg transform translate-x-full transition-transform duration-500 ease-in-out z-50 focus:outline-none" id="sidePanel" tabindex="-1">
   <div class="flex flex-col h-full p-6 space-y-6">
    <header class="flex items-center justify-between">
     <h2 class="text-xl font-bold text-orange-500">
      Configuración Rápida
     </h2>
     <button aria-label="Cerrar panel de configuración" class="text-orange-500 hover:text-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-500 rounded" id="closeSidePanel">
      <i class="fas fa-times fa-lg">
      </i>
     </button>
    </header>
    <section aria-labelledby="themeToggleLabel" class="space-y-2">
     <h3 class="text-lg font-semibold text-orange-400" id="themeToggleLabel">
      Tema
     </h3>
     <button aria-pressed="false" class="btn-orange px-4 py-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-orange-500" id="toggleThemeBtn">
      Modo Automático
     </button>
    </section>
    <section aria-labelledby="assistantConfigLabel" class="space-y-2">
     <h3 class="text-lg font-semibold text-orange-400" id="assistantConfigLabel">
      Asistente Horizon ScriptMind
     </h3>
     <label class="block text-sm text-orange-300" for="freqRange">
      Frecuencia de sugerencias:
      <span id="freqValue">
       3
      </span>
     </label>
     <input class="w-full" id="freqRange" max="10" min="1" type="range" value="3"/>
     <label class="block text-sm text-orange-300 mt-2" for="styleSelect">
      Estilo de sugerencias:
     </label>
     <select class="w-full rounded bg-[#222222] text-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-500" id="styleSelect">
      <option value="formal">
       Formal
      </option>
      <option value="casual">
       Casual
      </option>
      <option value="motivacional">
       Motivacional
      </option>
      <option value="tecnico">
       Técnico
      </option>
     </select>
    </section>
    <section aria-labelledby="profileConfigLabel" class="space-y-2">
     <h3 class="text-lg font-semibold text-orange-400" id="profileConfigLabel">
      Perfil y Preferencias
     </h3>
     <label class="block text-sm text-orange-300" for="usernameInput">
      Nombre de usuario:
     </label>
     <input class="w-full rounded bg-[#222222] text-orange-400 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" id="usernameInput" placeholder="Tu nombre" type="text"/>
     <button class="btn-orange px-4 py-2 rounded w-full mt-2 focus:outline-none focus:ring-2 focus:ring-orange-500" id="saveProfileBtn">
      Guardar Perfil
     </button>
    </section>
    <section aria-label="Exportar e importar configuración" class="space-y-2">
     <h3 class="text-lg font-semibold text-orange-400">
      Exportar / Importar
     </h3>
     <button class="btn-orange px-4 py-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-orange-500" id="exportConfigBtn">
      Exportar Configuración
     </button>
     <input accept="application/json" class="hidden" id="importConfigInput" type="file"/>
     <button class="btn-orange px-4 py-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-orange-500" id="importConfigBtn">
      Importar Configuración
     </button>
    </section>
   </div>
  </aside>
  <!-- Header -->
  <header class="flex items-center justify-between px-6 py-4 border-b border-[#2a2a2a] sticky top-0 bg-[#121212] z-40">
   <div class="flex items-center space-x-3">
    <button aria-label="Abrir panel de configuración rápida" class="text-orange-500 hover:text-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-500 rounded" id="openSidePanelBtn">
     <i class="fas fa-cogs fa-lg">
     </i>
    </button>
    <h1 class="text-2xl font-bold tracking-wide text-orange-500 select-none">
     MyHorizon
    </h1>
   </div>
   <nav aria-label="Navegación principal" class="hidden md:flex space-x-8 font-semibold text-orange-400">
    <button class="tab-btn focus:outline-none focus:ring-2 focus:ring-orange-500 rounded" data-tab="dashboard">
     Dashboard
    </button>
    <button class="tab-btn focus:outline-none focus:ring-2 focus:ring-orange-500 rounded" data-tab="nexusflow">
     NexusFlowTR©
    </button>
    <button class="tab-btn focus:outline-none focus:ring-2 focus:ring-orange-500 rounded" data-tab="mindsphere">
     MindSphereTR©
    </button>
    <button class="tab-btn focus:outline-none focus:ring-2 focus:ring-orange-500 rounded" data-tab="echowallet">
     EchoWalletTR©
    </button>
   </nav>
   <button aria-label="Abrir menú móvil" class="md:hidden text-orange-500 hover:text-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-500 rounded" id="mobileMenuBtn">
    <i class="fas fa-bars fa-lg">
    </i>
   </button>
  </header>
  <!-- Mobile Navigation -->
  <nav aria-label="Navegación móvil" class="fixed top-16 left-0 w-full bg-[#121212] border-b border-[#2a2a2a] z-40 hidden md:hidden" id="mobileNav">
   <div class="flex flex-col space-y-1 p-4 font-semibold text-orange-400">
    <button class="tab-btn-mobile text-left focus:outline-none focus:ring-2 focus:ring-orange-500 rounded px-2 py-2" data-tab="dashboard">
     Dashboard
    </button>
    <button class="tab-btn-mobile text-left focus:outline-none focus:ring-2 focus:ring-orange-500 rounded px-2 py-2" data-tab="nexusflow">
     NexusFlowTR©
    </button>
    <button class="tab-btn-mobile text-left focus:outline-none focus:ring-2 focus:ring-orange-500 rounded px-2 py-2" data-tab="mindsphere">
     MindSphereTR©
    </button>
    <button class="tab-btn-mobile text-left focus:outline-none focus:ring-2 focus:ring-orange-500 rounded px-2 py-2" data-tab="echowallet">
     EchoWalletTR©
    </button>
   </div>
  </nav>
  <main class="flex-grow overflow-auto" tabindex="0">
   <!-- Dashboard / Horizon Home -->
   <section aria-label="Dashboard multifuncional Horizon Home" class="tab-content p-6 space-y-8 max-w-7xl mx-auto" id="dashboard" tabindex="0">
    <h2 class="text-3xl font-bold text-orange-500 mb-4 select-none">
     Horizon Home
    </h2>
    <!-- Widgets Panel -->
    <section aria-label="Panel de widgets dinámicos" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
     <!-- Widget: Reloj Mundial -->
     <article aria-label="Widget Reloj Mundial" class="bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative" tabindex="0">
      <h3 class="text-xl font-semibold text-orange-400 mb-3 select-none">
       Reloj Mundial
      </h3>
      <div class="flex flex-col space-y-2">
       <div class="flex justify-between items-center text-orange-300 font-mono text-lg">
        <span>
         UTC
        </span>
        <time aria-atomic="true" aria-live="polite" id="timeUTC">
         --:--:--
        </time>
       </div>
       <div class="flex justify-between items-center text-orange-300 font-mono text-lg">
        <span>
         Tokyo
        </span>
        <time aria-atomic="true" aria-live="polite" id="timeTokyo">
         --:--:--
        </time>
       </div>
       <div class="flex justify-between items-center text-orange-300 font-mono text-lg">
        <span>
         New York
        </span>
        <time aria-atomic="true" aria-live="polite" id="timeNY">
         --:--:--
        </time>
       </div>
      </div>
     </article>
     <!-- Widget: Clima Ficticio -->
     <article aria-label="Widget Clima Ficticio" class="bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative" tabindex="0">
      <h3 class="text-xl font-semibold text-orange-400 mb-3 select-none">
       Clima
      </h3>
      <div class="flex items-center space-x-4">
       <img alt="Icono de sol naranja brillante con rayos estilizados en fondo negro carbón" height="64" src="https://storage.googleapis.com/a1aa/image/91efef25-186a-4094-8a6f-2413b8af95a2.jpg" width="64"/>
       <div>
        <p class="text-orange-300 font-semibold text-lg">
         Ciudad: NeoHorizon
        </p>
        <p class="text-orange-400 font-bold text-3xl">
         28°C
        </p>
        <p class="text-orange-300 italic">
         Soleado con brisa ligera
        </p>
       </div>
      </div>
     </article>
     <!-- Widget: Noticias Ficticias -->
     <article aria-label="Widget Noticias Ficticias" class="bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative" tabindex="0">
      <h3 class="text-xl font-semibold text-orange-400 mb-3 select-none">
       Noticias
      </h3>
      <ul aria-atomic="true" aria-live="polite" class="list-disc list-inside space-y-2 max-h-48 overflow-y-auto text-orange-300 text-sm">
       <li>
        MyHorizon lanza nueva actualización con widgets 3D volumétricos.
       </li>
       <li>
        Simulación de colaboración multiusuario en NexusFlowTR© mejora productividad.
       </li>
       <li>
        MindSphereTR© introduce modo enfoque con sonidos ambientales.
       </li>
       <li>
        EchoWalletTR© presenta jardín financiero para visualización de gastos.
       </li>
       <li>
        Panel lateral de configuración rápida ahora disponible para personalización.
       </li>
       <li>
        Nuevo sistema de recompensas desbloqueables con animaciones exclusivas.
       </li>
       <li>
        Temporizadores Pomodoro integrados para mejorar concentración.
       </li>
       <li>
        Calendario lunar con fases animadas para planificación avanzada.
       </li>
       <li>
        Notas rápidas con tinta líquida naranja y grabación de voz local.
       </li>
       <li>
        Exportación e importación JSON para compartir proyectos y configuraciones.
       </li>
      </ul>
     </article>
     <!-- Widget: Temporizador Pomodoro -->
     <article aria-label="Widget Temporizador Pomodoro" class="bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative flex flex-col items-center" tabindex="0">
      <h3 class="text-xl font-semibold text-orange-400 mb-3 select-none">
       Temporizador Pomodoro
      </h3>
      <div class="text-orange-400 font-mono text-5xl select-none" id="pomodoroTimer">
       25:00
      </div>
      <div class="mt-4 flex space-x-4">
       <button aria-label="Iniciar temporizador" class="btn-orange px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-orange-500" id="pomodoroStart">
        Iniciar
       </button>
       <button aria-label="Pausar temporizador" class="btn-orange px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-orange-500" disabled="" id="pomodoroPause">
        Pausar
       </button>
       <button aria-label="Reiniciar temporizador" class="btn-orange px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-orange-500" id="pomodoroReset">
        Reiniciar
       </button>
      </div>
     </article>
     <!-- Widget: Notas Rápidas -->
     <article aria-label="Widget Notas Rápidas" class="bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative flex flex-col" tabindex="0">
      <h3 class="text-xl font-semibold text-orange-400 mb-3 select-none">
       Notas Rápidas
      </h3>
      <textarea class="bg-[#222222] text-orange-300 rounded p-3 resize-none focus:outline-none focus:ring-2 focus:ring-orange-500 font-mono" id="quickNotes" placeholder="Escribe tus notas aquí..." rows="5"></textarea>
      <button aria-label="Guardar notas rápidas" class="btn-orange mt-3 px-4 py-2 rounded self-end focus:outline-none focus:ring-2 focus:ring-orange-500" id="saveQuickNotes">
       Guardar
      </button>
     </article>
     <!-- Widget: Calendario Lunar -->
     <article aria-label="Widget Calendario Lunar" class="bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative" tabindex="0">
      <h3 class="text-xl font-semibold text-orange-400 mb-3 select-none">
       Calendario Lunar
      </h3>
      <div class="flex items-center space-x-4">
       <img alt="Icono de luna naranja estilizada con fases en fondo negro carbón" height="64" src="https://storage.googleapis.com/a1aa/image/4f4f6a27-74dd-4b12-220a-075b49948c59.jpg" width="64"/>
       <div>
        <p class="text-orange-300 font-semibold text-lg" id="lunarPhaseName">
         Fase Lunar: Luna Nueva
        </p>
        <p class="text-orange-400 font-bold text-3xl" id="lunarPhaseDate">
         27 Abril 2024
        </p>
        <p class="text-orange-300 italic" id="lunarPhaseDesc">
         Inicio del ciclo lunar, momento ideal para nuevos comienzos.
        </p>
       </div>
      </div>
     </article>
    </section>
    <!-- Widget 3D Volumétricos Interactivos -->
    <section aria-label="Widgets 3D volumétricos interactivos" class="mt-12">
     <h3 class="text-2xl font-bold text-orange-500 mb-6 select-none">
      Widgets 3D Volumétricos
     </h3>
     <div aria-describedby="widget3DDesc" class="w-full h-64 rounded-lg shadow-lg bg-[#1a1a1a] relative overflow-hidden" id="widget3DContainer" tabindex="0">
      <p class="sr-only" id="widget3DDesc">
       Interfaz 3D volumétrica con interacción táctil y con mouse para explorar widgets.
      </p>
      <canvas aria-label="Canvas 3D volumétrico interactivo" class="w-full h-full" id="widget3DCanvas">
      </canvas>
     </div>
    </section>
    <!-- Asistente Horizon ScriptMind -->
    <section aria-label="Asistente Horizon ScriptMind" class="mt-12 bg-[#1a1a1a] rounded-lg p-6 morph-shape holo-loading shadow-lg relative" tabindex="0">
     <h3 class="text-2xl font-bold text-orange-500 mb-4 select-none">
      Horizon ScriptMind
     </h3>
     <div aria-atomic="true" aria-live="polite" aria-relevant="additions" class="min-h-[6rem] text-orange-300 font-mono text-lg leading-relaxed select-text" id="assistantOutput" role="log" tabindex="0">
     </div>
     <div class="mt-4 flex space-x-4">
      <button aria-label="Solicitar sugerencia al asistente" class="btn-orange px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-orange-500" id="assistantSuggestBtn">
       Solicitar Sugerencia
      </button>
      <button aria-label="Limpiar sugerencias" class="btn-orange px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-orange-500" id="assistantClearBtn">
       Limpiar
      </button>
     </div>
    </section>
   </section>
   <!-- NexusFlowTR© - Gestor avanzado de tareas y proyectos -->
   <section aria-label="Gestor avanzado de tareas y proyectos NexusFlowTR©" class="tab-content hidden p-6 max-w-7xl mx-auto space-y-8" id="nexusflow" tabindex="0">
    <h2 class="text-3xl font-bold text-orange-500 mb-4 select-none">
     NexusFlowTR©
    </h2>
    <div class="flex flex-col lg:flex-row gap-6">
     <!-- Panel de proyectos -->
     <section aria-label="Lista de proyectos" class="flex-1 bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative flex flex-col max-h-[600px]">
      <header class="flex justify-between items-center mb-4">
       <h3 class="text-xl font-semibold text-orange-400 select-none">
        Proyectos
       </h3>
       <button aria-label="Agregar nuevo proyecto" class="btn-orange px-3 py-1 rounded focus:outline-none focus:ring-2 focus:ring-orange-500" id="addProjectBtn">
        <i class="fas fa-plus">
        </i>
        Nuevo
       </button>
      </header>
      <ul aria-atomic="true" aria-live="polite" class="overflow-y-auto flex-grow space-y-2 text-orange-300 font-mono" id="projectList" role="list" tabindex="0">
      </ul>
     </section>
     <!-- Visualización 3D de proyectos -->
     <section aria-label="Visualización 3D de proyectos" class="flex-1 bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative flex flex-col">
      <h3 class="text-xl font-semibold text-orange-400 mb-4 select-none">
       Ecosistema 3D de Proyectos
      </h3>
      <div aria-describedby="project3DDesc" class="flex-grow rounded-lg bg-[#222222] shadow-inner relative overflow-hidden" id="project3DView" tabindex="0">
       <p class="sr-only" id="project3DDesc">
        Visualización 3D interactiva de proyectos como ecosistemas vivos y expandibles.
       </p>
       <canvas aria-label="Canvas 3D para visualización de proyectos" class="w-full h-full" id="project3DCanvas">
       </canvas>
      </div>
     </section>
    </div>
    <!-- Panel de detalles y tareas -->
    <section aria-label="Detalles y tareas del proyecto seleccionado" class="bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative mt-6 max-h-[300px] overflow-y-auto" tabindex="0">
     <h3 class="text-xl font-semibold text-orange-400 mb-4 select-none">
      Detalles y Tareas
     </h3>
     <div aria-atomic="true" aria-live="polite" class="text-orange-300 font-mono text-sm space-y-2" id="projectDetails" tabindex="0">
     </div>
    </section>
   </section>
   <!-- MindSphereTR© - Cuaderno creativo multidimensional -->
   <section aria-label="Cuaderno creativo multidimensional MindSphereTR©" class="tab-content hidden p-6 max-w-7xl mx-auto space-y-8" id="mindsphere" tabindex="0">
    <h2 class="text-3xl font-bold text-orange-500 mb-4 select-none">
     MindSphereTR©
    </h2>
    <div class="flex flex-col lg:flex-row gap-6">
     <!-- Notas de texto -->
     <section aria-label="Notas de texto" class="flex-1 bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative flex flex-col">
      <h3 class="text-xl font-semibold text-orange-400 mb-3 select-none">
       Notas de Texto
      </h3>
      <textarea class="bg-[#222222] text-orange-300 rounded p-3 resize-none focus:outline-none focus:ring-2 focus:ring-orange-500 font-mono flex-grow" id="mindTextNotes" placeholder="Escribe tus ideas aquí..." rows="10"></textarea>
      <button aria-label="Guardar notas de texto" class="btn-orange mt-3 px-4 py-2 rounded self-end focus:outline-none focus:ring-2 focus:ring-orange-500" id="saveMindTextBtn">
       Guardar
      </button>
     </section>
     <!-- Dibujo con tinta líquida naranja -->
     <section aria-label="Dibujo con tinta líquida naranja" class="flex-1 bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative flex flex-col">
      <h3 class="text-xl font-semibold text-orange-400 mb-3 select-none">
       Dibujo Líquido
      </h3>
      <canvas aria-label="Lienzo para dibujo con tinta líquida naranja" class="rounded border border-orange-600 bg-[#121212] flex-grow" id="liquidInkCanvas" tabindex="0">
      </canvas>
      <div class="mt-3 flex space-x-4">
       <button aria-label="Limpiar dibujo" class="btn-orange px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-orange-500" id="clearInkBtn">
        Limpiar
       </button>
       <button aria-label="Guardar dibujo" class="btn-orange px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-orange-500" id="saveInkBtn">
        Guardar
       </button>
      </div>
     </section>
    </div>
    <!-- Mapas conceptuales -->
    <section aria-label="Mapas conceptuales con conexiones animadas" class="bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative mt-6" tabindex="0">
     <h3 class="text-xl font-semibold text-orange-400 mb-3 select-none">
      Mapas Conceptuales
     </h3>
     <div aria-label="Lienzo infinito para creación y edición de mapas conceptuales" class="w-full h-96 rounded border border-orange-600 bg-[#121212] relative overflow-hidden" id="conceptMapContainer" tabindex="0">
      <canvas aria-label="Canvas para mapas conceptuales con conexiones animadas" class="w-full h-full" id="conceptMapCanvas">
      </canvas>
     </div>
    </section>
    <!-- Buscador interno avanzado -->
    <section aria-label="Buscador interno avanzado" class="mt-6">
     <label class="block text-orange-400 font-semibold mb-2" for="mindSearchInput">
      Buscar en MindSphereTR©
     </label>
     <input aria-autocomplete="list" aria-controls="mindSearchResults" aria-haspopup="listbox" class="w-full rounded bg-[#222222] text-orange-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500 font-mono" id="mindSearchInput" placeholder="Buscar notas, dibujos, mapas..." type="search"/>
     <ul aria-atomic="true" aria-live="polite" class="mt-2 max-h-48 overflow-y-auto bg-[#1a1a1a] rounded shadow-inner text-orange-300 font-mono text-sm space-y-1" id="mindSearchResults" role="listbox" tabindex="0">
     </ul>
    </section>
   </section>
   <!-- EchoWalletTR© - Finanzas visuales y gamificadas -->
   <section aria-label="Finanzas visuales y gamificadas EchoWalletTR©" class="tab-content hidden p-6 max-w-7xl mx-auto space-y-8" id="echowallet" tabindex="0">
    <h2 class="text-3xl font-bold text-orange-500 mb-4 select-none">
     EchoWalletTR©
    </h2>
    <div class="flex flex-col lg:flex-row gap-6">
     <!-- Control de ingresos y gastos -->
     <section aria-label="Control de ingresos y gastos" class="flex-1 bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative flex flex-col max-h-[600px]">
      <header class="flex justify-between items-center mb-4">
       <h3 class="text-xl font-semibold text-orange-400 select-none">
        Ingresos y Gastos
       </h3>
       <button aria-label="Agregar nueva transacción" class="btn-orange px-3 py-1 rounded focus:outline-none focus:ring-2 focus:ring-orange-500" id="addTransactionBtn">
        <i class="fas fa-plus">
        </i>
        Nuevo
       </button>
      </header>
      <ul aria-atomic="true" aria-live="polite" class="overflow-y-auto flex-grow space-y-2 text-orange-300 font-mono" id="transactionList" role="list" tabindex="0">
      </ul>
      <div class="mt-4 text-orange-400 font-mono text-lg flex justify-between">
       <span>
        Total Ingresos:
        <strong id="totalIncome">
         0
        </strong>
        €
       </span>
       <span>
        Total Gastos:
        <strong id="totalExpense">
         0
        </strong>
        €
       </span>
      </div>
     </section>
     <!-- Jardín financiero -->
     <section aria-label="Visualización tipo jardín financiero" class="flex-1 bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative flex flex-col">
      <h3 class="text-xl font-semibold text-orange-400 mb-4 select-none">
       Jardín Financiero
      </h3>
      <canvas aria-label="Canvas para visualización tipo jardín financiero" class="rounded border border-orange-600 bg-[#121212] flex-grow" id="financeGardenCanvas" tabindex="0">
      </canvas>
     </section>
    </div>
    <!-- Simulador de metas y proyecciones -->
    <section aria-label="Simulador manual de metas y proyecciones de ahorro" class="bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative mt-6" tabindex="0">
     <h3 class="text-xl font-semibold text-orange-400 mb-3 select-none">
      Simulador de Metas y Proyecciones
     </h3>
     <form class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-orange-300 font-mono" id="savingsSimulatorForm">
      <label class="flex flex-col" for="monthlyIncome">
       Ingreso mensual (€)
       <input class="mt-1 rounded bg-[#222222] text-orange-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" id="monthlyIncome" min="0" step="10" type="number" value="2000"/>
      </label>
      <label class="flex flex-col" for="monthlySavings">
       Ahorro mensual (€)
       <input class="mt-1 rounded bg-[#222222] text-orange-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" id="monthlySavings" min="0" step="10" type="number" value="500"/>
      </label>
      <label class="flex flex-col" for="goalAmount">
       Meta de ahorro (€)
       <input class="mt-1 rounded bg-[#222222] text-orange-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" id="goalAmount" min="0" step="100" type="number" value="10000"/>
      </label>
      <button class="btn-orange col-span-full px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-orange-500 mt-2" type="submit">
       Calcular Proyección
      </button>
     </form>
     <div aria-atomic="true" aria-live="polite" class="mt-4 text-orange-400 font-mono text-lg select-text" id="savingsProjectionResult">
     </div>
    </section>
    <!-- Sistema de recompensas y logros -->
    <section aria-label="Sistema de recompensas y logros desbloqueables" class="bg-[#1a1a1a] rounded-lg p-5 morph-shape holo-loading shadow-lg relative mt-6" tabindex="0">
     <h3 class="text-xl font-semibold text-orange-400 mb-3 select-none">
      Recompensas y Logros
     </h3>
     <ul class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-orange-300 font-mono" id="achievementsList">
      <li aria-label="Logro: Primer ingreso registrado" class="bg-[#222222] rounded p-3 flex flex-col items-center justify-center morph-shape transition-smooth hover:shadow-[0_0_15px_3px_rgba(255,106,0,0.7)]" tabindex="0">
       <i class="fas fa-coins fa-2x icon-orange mb-2">
       </i>
       <span>
        Primer ingreso registrado
       </span>
      </li>
      <li aria-label="Logro: 5 gastos registrados" class="bg-[#222222] rounded p-3 flex flex-col items-center justify-center morph-shape transition-smooth hover:shadow-[0_0_15px_3px_rgba(255,106,0,0.7)]" tabindex="0">
       <i class="fas fa-wallet fa-2x icon-orange mb-2">
       </i>
       <span>
        5 gastos registrados
       </span>
      </li>
      <li aria-label="Logro: Meta de ahorro alcanzada" class="bg-[#222222] rounded p-3 flex flex-col items-center justify-center morph-shape transition-smooth hover:shadow-[0_0_15px_3px_rgba(255,106,0,0.7)]" tabindex="0">
       <i class="fas fa-trophy fa-2x icon-orange mb-2">
       </i>
       <span>
        Meta de ahorro alcanzada
       </span>
      </li>
      <li aria-label="Logro: 10 transacciones registradas" class="bg-[#222222] rounded p-3 flex flex-col items-center justify-center morph-shape transition-smooth hover:shadow-[0_0_15px_3px_rgba(255,106,0,0.7)]" tabindex="0">
       <i class="fas fa-list fa-2x icon-orange mb-2">
       </i>
       <span>
        10 transacciones registradas
       </span>
      </li>
      <li aria-label="Logro: Uso diario por 7 días" class="bg-[#222222] rounded p-3 flex flex-col items-center justify-center morph-shape transition-smooth hover:shadow-[0_0_15px_3px_rgba(255,106,0,0.7)]" tabindex="0">
       <i class="fas fa-calendar-check fa-2x icon-orange mb-2">
       </i>
       <span>
        Uso diario por 7 días
       </span>
      </li>
      <li aria-label="Logro: Exportación de datos realizada" class="bg-[#222222] rounded p-3 flex flex-col items-center justify-center morph-shape transition-smooth hover:shadow-[0_0_15px_3px_rgba(255,106,0,0.7)]" tabindex="0">
       <i class="fas fa-file-export fa-2x icon-orange mb-2">
       </i>
       <span>
        Exportación de datos realizada
       </span>
      </li>
     </ul>
    </section>
   </section>
   <!-- Footer -->
   <footer class="bg-[#121212] border-t border-[#2a2a2a] p-4 text-center text-orange-400 text-sm select-none">
    © 2024 MyHorizon. Todos los derechos reservados.
   </footer>
   <script>
    (() => {
  'use strict';

  // Variables y estado global
  const state = {
    themeAuto: true,
    themeMode: 'default', // 'default' or 'productive'
    assistantConfig: {
      frequency: 3,
      style: 'formal',
    },
    username: '',
    pomodoro: {
      running: false,
      timerId: null,
      timeLeft: 1500, // 25 min in seconds
    },
    quickNotes: '',
    mindTextNotes: '',
    projects: [],
    selectedProjectId: null,
    transactions: [],
    achievements: new Set(),
    savingsProjection: null,
  };

  // Elementos DOM
  const sidePanel = document.getElementById('sidePanel');
  const openSidePanelBtn = document.getElementById('openSidePanelBtn');
  const closeSidePanelBtn = document.getElementById('closeSidePanel');
  const toggleThemeBtn = document.getElementById('toggleThemeBtn');
  const freqRange = document.getElementById('freqRange');
  const freqValue = document.getElementById('freqValue');
  const styleSelect = document.getElementById('styleSelect');
  const usernameInput = document.getElementById('usernameInput');
  const saveProfileBtn = document.getElementById('saveProfileBtn');
  const exportConfigBtn = document.getElementById('exportConfigBtn');
  const importConfigBtn = document.getElementById('importConfigBtn');
  const importConfigInput = document.getElementById('importConfigInput');

  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabButtonsMobile = document.querySelectorAll('.tab-btn-mobile');
  const tabContents = document.querySelectorAll('.tab-content');
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const mobileNav = document.getElementById('mobileNav');

  // Dashboard widgets
  const timeUTC = document.getElementById('timeUTC');
  const timeTokyo = document.getElementById('timeTokyo');
  const timeNY = document.getElementById('timeNY');

  // Pomodoro
  const pomodoroTimer = document.getElementById('pomodoroTimer');
  const pomodoroStart = document.getElementById('pomodoroStart');
  const pomodoroPause = document.getElementById('pomodoroPause');
  const pomodoroReset = document.getElementById('pomodoroReset');

  // Quick notes
  const quickNotesTextarea = document.getElementById('quickNotes');
  const saveQuickNotesBtn = document.getElementById('saveQuickNotes');

  // Lunar calendar
  const lunarPhaseName = document.getElementById('lunarPhaseName');
  const lunarPhaseDate = document.getElementById('lunarPhaseDate');
  const lunarPhaseDesc = document.getElementById('lunarPhaseDesc');

  // Assistant
  const assistantOutput = document.getElementById('assistantOutput');
  const assistantSuggestBtn = document.getElementById('assistantSuggestBtn');
  const assistantClearBtn = document.getElementById('assistantClearBtn');

  // NexusFlowTR©
  const addProjectBtn = document.getElementById('addProjectBtn');
  const projectList = document.getElementById('projectList');
  const projectDetails = document.getElementById('projectDetails');
  const project3DCanvas = document.getElementById('project3DCanvas');

  // MindSphereTR©
  const mindTextNotesTextarea = document.getElementById('mindTextNotes');
  const saveMindTextBtn = document.getElementById('saveMindTextBtn');
  const liquidInkCanvas = document.getElementById('liquidInkCanvas');
  const clearInkBtn = document.getElementById('clearInkBtn');
  const saveInkBtn = document.getElementById('saveInkBtn');
  const conceptMapCanvas = document.getElementById('conceptMapCanvas');
  const mindSearchInput = document.getElementById('mindSearchInput');
  const mindSearchResults = document.getElementById('mindSearchResults');

  // EchoWalletTR©
  const addTransactionBtn = document.getElementById('addTransactionBtn');
  const transactionList = document.getElementById('transactionList');
  const totalIncomeEl = document.getElementById('totalIncome');
  const totalExpenseEl = document.getElementById('totalExpense');
  const financeGardenCanvas = document.getElementById('financeGardenCanvas');
  const savingsSimulatorForm = document.getElementById('savingsSimulatorForm');
  const savingsProjectionResult = document.getElementById('savingsProjectionResult');
  const achievementsList = document.getElementById('achievementsList');

  // Widget 3D volumétricos
  const widget3DCanvas = document.getElementById('widget3DCanvas');

  // Utilidades
  function saveToStorage() {
    try {
      const data = {
        themeAuto: state.themeAuto,
        themeMode: state.themeMode,
        assistantConfig: state.assistantConfig,
        username: state.username,
        pomodoro: state.pomodoro,
        quickNotes: state.quickNotes,
        mindTextNotes: state.mindTextNotes,
        projects: state.projects,
        selectedProjectId: state.selectedProjectId,
        transactions: state.transactions,
        achievements: Array.from(state.achievements),
      };
      const encrypted = btoa(JSON.stringify(data)); // simple base64 "encryption"
      localStorage.setItem('myhorizon_data', encrypted);
    } catch (e) {
      console.error('Error guardando datos:', e);
    }
  }
  function loadFromStorage() {
    try {
      const encrypted = localStorage.getItem('myhorizon_data');
      if (!encrypted) return;
      const data = JSON.parse(atob(encrypted));
      if (data.themeAuto !== undefined) state.themeAuto = data.themeAuto;
      if (data.themeMode) state.themeMode = data.themeMode;
      if (data.assistantConfig) state.assistantConfig = data.assistantConfig;
      if (data.username) state.username = data.username;
      if (data.pomodoro) state.pomodoro = data.pomodoro;
      if (data.quickNotes) state.quickNotes = data.quickNotes;
      if (data.mindTextNotes) state.mindTextNotes = data.mindTextNotes;
      if (data.projects) state.projects = data.projects;
      if (data.selectedProjectId) state.selectedProjectId = data.selectedProjectId;
      if (data.transactions) state.transactions = data.transactions;
      if (data.achievements) state.achievements = new Set(data.achievements);
    } catch (e) {
      console.error('Error cargando datos:', e);
    }
  }

  // Tema automático según hora y modo
  function applyTheme() {
    if (!state.themeAuto) {
      document.documentElement.style.setProperty('--color-orange', 'var(--color-orange)');
      return;
    }
    const hour = new Date().getHours();
    if (hour >= 9 && hour < 18) {
      // Modo productivo: naranja más intenso
      document.documentElement.style.setProperty('--color-orange', 'var(--color-orange-intense)');
      state.themeMode = 'productive';
    } else {
      document.documentElement.style.setProperty('--color-orange', '#ff6a00');
      state.themeMode = 'default';
    }
  }

  // Actualizar reloj mundial
  function updateWorldClocks() {
    const now = new Date();
    // UTC
    timeUTC.textContent = now.toISOString().slice(11, 19);
    // Tokyo UTC+9
    const tokyo = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
    timeTokyo.textContent = tokyo.toTimeString().slice(0, 8);
    // New York UTC-4 or -5 (DST)
    const ny = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
    timeNY.textContent = ny.toTimeString().slice(0, 8);
  }

  // Pomodoro timer
  function updatePomodoroDisplay() {
    const minutes = Math.floor(state.pomodoro.timeLeft / 60).toString().padStart(2, '0');
    const seconds = (state.pomodoro.timeLeft % 60).toString().padStart(2, '0');
    pomodoroTimer.textContent = `${minutes}:${seconds}`;
  }
  function pomodoroTick() {
    if (state.pomodoro.timeLeft > 0) {
      state.pomodoro.timeLeft--;
      updatePomodoroDisplay();
    } else {
      clearInterval(state.pomodoro.timerId);
      state.pomodoro.running = false;
      pomodoroStart.disabled = false;
      pomodoroPause.disabled = true;
      playSound('alarm');
      vibrateSim(1000);
      alert('¡Pomodoro terminado! Toma un descanso.');
    }
  }
  function startPomodoro() {
    if (state.pomodoro.running) return;
    state.pomodoro.running = true;
    pomodoroStart.disabled = true;
    pomodoroPause.disabled = false;
    state.pomodoro.timerId = setInterval(pomodoroTick, 1000);
  }
  function pausePomodoro() {
    if (!state.pomodoro.running) return;
    clearInterval(state.pomodoro.timerId);
    state.pomodoro.running = false;
    pomodoroStart.disabled = false;
    pomodoroPause.disabled = true;
  }
  function resetPomodoro() {
    clearInterval(state.pomodoro.timerId);
    state.pomodoro.running = false;
    state.pomodoro.timeLeft = 1500;
    updatePomodoroDisplay();
    pomodoroStart.disabled = false;
    pomodoroPause.disabled = true;
  }

  // Guardar notas rápidas
  function saveQuickNotes() {
    state.quickNotes = quickNotesTextarea.value;
    saveToStorage();
    showTempMessage(saveQuickNotesBtn, 'Guardado');
  }

  // Calendario lunar (simplificado)
  function updateLunarCalendar() {
    const now = new Date();
    const lunarCycleDays = 29.53;
    const newMoon = new Date('2024-04-08T00:00:00Z'); // fecha de luna nueva conocida
    const diff = (now - newMoon) / (1000 * 60 * 60 * 24);
    const phase = diff % lunarCycleDays;
    let phaseName = '';
    let phaseDesc = '';
    if (phase < 1.84566) {
      phaseName = 'Luna Nueva';
      phaseDesc = 'Inicio del ciclo lunar, momento ideal para nuevos comienzos.';
    } else if (phase < 5.53699) {
      phaseName = 'Luna Creciente';
      phaseDesc = 'Fase de crecimiento y expansión.';
    } else if (phase < 9.22831) {
      phaseName = 'Cuarto Creciente';
      phaseDesc = 'Momento para tomar decisiones importantes.';
    } else if (phase < 12.91963) {
      phaseName = 'Gibosa Creciente';
      phaseDesc = 'Crecimiento acelerado y energía alta.';
    } else if (phase < 16.61096) {
      phaseName = 'Luna Llena';
      phaseDesc = 'Pico de energía y culminación.';
    } else if (phase < 20.30228) {
      phaseName = 'Gibosa Menguante';
      phaseDesc = 'Disminución gradual, reflexión.';
    } else if (phase < 23.99361) {
      phaseName = 'Cuarto Menguante';
      phaseDesc = 'Liberación y limpieza.';
    } else if (phase < 27.68493) {
      phaseName = 'Luna Menguante';
      phaseDesc = 'Preparación para el nuevo ciclo.';
    } else {
      phaseName = 'Luna Nueva';
      phaseDesc = 'Inicio del ciclo lunar, momento ideal para nuevos comienzos.';
    }
    lunarPhaseName.textContent = `Fase Lunar: ${phaseName}`;
    lunarPhaseDate.textContent = now.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
    lunarPhaseDesc.textContent = phaseDesc;
  }

  // Asistente Horizon ScriptMind - respuestas preprogramadas
  const assistantResponses = {
    formal: [
      "Recuerde priorizar sus tareas según la fecha de entrega y la importancia.",
      "Mantenga un equilibrio entre trabajo y descanso para maximizar su productividad.",
      "Considere revisar sus metas semanales para ajustar su planificación.",
      "La organización es clave para el éxito en proyectos complejos.",
      "No olvide guardar sus notas frecuentemente para evitar pérdidas de información."
    ],
    casual: [
      "¡Hey! ¿Ya revisaste tus tareas para hoy?",
      "Un descanso corto puede ayudarte a recargar energías.",
      "¿Qué tal si organizas tus proyectos por prioridad?",
      "No olvides guardar tus notas, ¡no queremos perder nada!",
      "¡Vamos! ¡Tú puedes con todo hoy!"
    ],
    motivacional: [
      "Cada pequeño paso te acerca a tu gran meta.",
      "La constancia es la clave del éxito, sigue adelante.",
      "No te rindas, los grandes logros requieren tiempo.",
      "Tu esfuerzo de hoy será la recompensa de mañana.",
      "Confía en ti mismo y en tu capacidad para crear."
    ],
    tecnico: [
      "Recuerde validar los datos antes de exportar el proyecto.",
      "Utilice etiquetas para filtrar tareas de manera eficiente.",
      "La sincronización local garantiza la privacidad de sus datos.",
      "Aproveche el modo enfoque para minimizar distracciones.",
      "Considere usar el temporizador Pomodoro para mejorar la concentración."
    ]
  };
  function getAssistantSuggestion() {
    const style = state.assistantConfig.style || 'formal';
    const responses = assistantResponses[style] || assistantResponses.formal;
    const index = Math.floor(Math.random() * responses.length);
    return responses[index];
  }
  function addAssistantSuggestion() {
    const suggestion = getAssistantSuggestion();
    const p = document.createElement('p');
    p.textContent = suggestion;
    assistantOutput.appendChild(p);
    assistantOutput.scrollTop = assistantOutput.scrollHeight;
  }
  function clearAssistantSuggestions() {
    assistantOutput.innerHTML = '';
  }

  // Navegación entre pestañas
  function switchTab(tabName) {
    tabContents.forEach(tc => {
      if (tc.id === tabName) {
        tc.classList.remove('hidden');
        tc.setAttribute('tabindex', '0');
      } else {
        tc.classList.add('hidden');
        tc.setAttribute('tabindex', '-1');
      }
    });
    tabButtons.forEach(btn => {
      if (btn.dataset.tab === tabName) {
        btn.classList.add('text-orange-500', 'font-bold');
        btn.setAttribute('aria-current', 'page');
      } else {
        btn.classList.remove('text-orange-500', 'font-bold');
        btn.removeAttribute('aria-current');
      }
    });
    tabButtonsMobile.forEach(btn => {
      if (btn.dataset.tab === tabName) {
        btn.classList.add('text-orange-500', 'font-bold');
        btn.setAttribute('aria-current', 'page');
      } else {
        btn.classList.remove('text-orange-500', 'font-bold');
        btn.removeAttribute('aria-current');
      }
    });
    if (mobileNav.classList.contains('block')) {
      mobileNav.classList.remove('block');
      mobileNav.classList.add('hidden');
    }
  }

  // Abrir y cerrar panel lateral
  function openSidePanel() {
    sidePanel.classList.remove('translate-x-full');
    sidePanel.focus();
  }
  function closeSidePanel() {
    sidePanel.classList.add('translate-x-full');
    openSidePanelBtn.focus();
  }

  // Mostrar mensaje temporal en botón
  function showTempMessage(button, message) {
    const original = button.textContent;
    button.textContent = message;
    setTimeout(() => {
      button.textContent = original;
    }, 1500);
  }

  // Exportar configuración
  function exportConfig() {
    const data = {
      themeAuto: state.themeAuto,
      themeMode: state.themeMode,
      assistantConfig: state.assistantConfig,
      username: state.username,
      pomodoro: state.pomodoro,
      quickNotes: state.quickNotes,
      mindTextNotes: state.mindTextNotes,
      projects: state.projects,
      selectedProjectId: state.selectedProjectId,
      transactions: state.transactions,
      achievements: Array.from(state.achievements),
    };
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'myhorizon_config.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  // Importar configuración
  function importConfig(file) {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        if (data.themeAuto !== undefined) state.themeAuto = data.themeAuto;
        if (data.themeMode) state.themeMode = data.themeMode;
        if (data.assistantConfig) state.assistantConfig = data.assistantConfig;
        if (data.username) state.username = data.username;
        if (data.pomodoro) state.pomodoro = data.pomodoro;
        if (data.quickNotes) state.quickNotes = data.quickNotes;
        if (data.mindTextNotes) state.mindTextNotes = data.mindTextNotes;
        if (data.projects) state.projects = data.projects;
        if (data.selectedProjectId) state.selectedProjectId = data.selectedProjectId;
        if (data.transactions) state.transactions = data.transactions;
        if (data.achievements) state.achievements = new Set(data.achievements);
        saveToStorage();
        loadAllDataToUI();
        alert('Configuración importada correctamente.');
      } catch (err) {
        alert('Error al importar configuración: archivo inválido.');
      }
    };
    reader.readAsText(file);
  }

  // Cargar datos a UI
  function loadAllDataToUI() {
    // Tema
    toggleThemeBtn.textContent = state.themeAuto ? 'Modo Automático' : 'Modo Manual';
    toggleThemeBtn.setAttribute('aria-pressed', state.themeAuto.toString());
    freqRange.value = state.assistantConfig.frequency || 3;
    freqValue.textContent = freqRange.value;
    styleSelect.value = state.assistantConfig.style || 'formal';
    usernameInput.value = state.username || '';

    // Pomodoro
    updatePomodoroDisplay();
    pomodoroPause.disabled = !state.pomodoro.running;
    pomodoroStart.disabled = state.pomodoro.running;

    // Quick notes
    quickNotesTextarea.value = state.quickNotes || '';

    // MindSphereTR©
    mindTextNotesTextarea.value = state.mindTextNotes || '';

    // Projects
    renderProjectList();
    renderProjectDetails();

    // Transactions
    renderTransactionList();
    updateTransactionTotals();

    // Achievements
    renderAchievements();

    // Lunar calendar
    updateLunarCalendar();

    // Assistant
    clearAssistantSuggestions();
  }

  // Renderizar lista de proyectos
  function renderProjectList() {
    projectList.innerHTML = '';
    if (state.projects.length === 0) {
      const li = document.createElement('li');
      li.textContent = 'No hay proyectos creados.';
      li.className = 'text-orange-500 italic select-none';
      projectList.appendChild(li);
      return;
    }
    state.projects.forEach(proj => {
      const li = document.createElement('li');
      li.className = 'cursor-pointer p-2 rounded hover:bg-[#222222] focus:bg-[#222222] focus:outline-none';
      li.tabIndex = 0;
      li.setAttribute('role', 'button');
      li.setAttribute('aria-pressed', (state.selectedProjectId === proj.id).toString());
      li.textContent = proj.name;
      if (state.selectedProjectId === proj.id) {
        li.classList.add('bg-orange-700', 'font-bold');
      }
      li.addEventListener('click', () => {
        state.selectedProjectId = proj.id;
        renderProjectList();
        renderProjectDetails();
      });
      li.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          li.click();
        }
      });
      projectList.appendChild(li);
    });
  }

  // Renderizar detalles del proyecto seleccionado
  function renderProjectDetails() {
    projectDetails.innerHTML = '';
    if (!state.selectedProjectId) {
      projectDetails.textContent = 'Selecciona un proyecto para ver detalles.';
      return;
    }
    const proj = state.projects.find(p => p.id === state.selectedProjectId);
    if (!proj) {
      projectDetails.textContent = 'Proyecto no encontrado.';
      return;
    }
    const title = document.createElement('h4');
    title.textContent = `Proyecto: ${proj.name}`;
    title.className = 'text-orange-400 font-bold mb-2';
    projectDetails.appendChild(title);

    if (!proj.tasks || proj.tasks.length === 0) {
      const p = document.createElement('p');
      p.textContent = 'No hay tareas en este proyecto.';
      p.className = 'italic';
      projectDetails.appendChild(p);
      return;
    }

    // Ordenar tareas por prioridad (fecha, importancia, duración)
    const sortedTasks = [...proj.tasks].sort((a, b) => {
      // Prioridad: fecha, importancia, duración
      const dateA = new Date(a.dueDate);
      const dateB = new Date(b.dueDate);
      if (dateA < dateB) return -1;
      if (dateA > dateB) return 1;
      if (a.importance > b.importance) return -1;
      if (a.importance < b.importance) return 1;
      if (a.duration < b.duration) return -1;
      if (a.duration > b.duration) return 1;
      return 0;
    });

    const ul = document.createElement('ul');
    ul.className = 'list-disc list-inside space-y-1';
    sortedTasks.forEach(task => {
      const li = document.createElement('li');
      li.className = 'flex justify-between items-center';
      const taskText = document.createElement('span');
      taskText.textContent = `${task.name} (Fecha: ${task.dueDate}, Importancia: ${task.importance}, Duración: ${task.duration}h)`;
      li.appendChild(taskText);

      const btnComplete = document.createElement('button');
      btnComplete.className = 'text-orange-500 hover:text-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-500 rounded ml-2';
      btnComplete.setAttribute('aria-label', `Marcar tarea ${task.name} como completada`);
      btnComplete.innerHTML = task.completed ? '<i class="fas fa-check-circle"></i>' : '<i class="far fa-circle"></i>';
      btnComplete.addEventListener('click', () => {
        task.completed = !task.completed;
        renderProjectDetails();
        saveToStorage();
        if (task.completed) {
          playSound('complete');
          vibrateSim(200);
        }
      });
      li.appendChild(btnComplete);

      ul.appendChild(li);
    });
    projectDetails.appendChild(ul);
  }

  // Agregar nuevo proyecto
  function addNewProject() {
    const name = prompt('Nombre del nuevo proyecto:');
    if (!name) return;
    const newProject = {
      id: crypto.randomUUID(),
      name,
      tasks: [],
    };
    state.projects.push(newProject);
    state.selectedProjectId = newProject.id;
    renderProjectList();
    renderProjectDetails();
    saveToStorage();
  }

  // Renderizar lista de transacciones
  function renderTransactionList() {
    transactionList.innerHTML = '';
    if (state.transactions.length === 0) {
      const li = document.createElement('li');
      li.textContent = 'No hay transacciones registradas.';
      li.className = 'text-orange-500 italic select-none';
      transactionList.appendChild(li);
      return;
    }
    state.transactions.forEach(tx => {
      const li = document.createElement('li');
      li.className = 'flex justify-between items-center p-2 rounded hover:bg-[#222222] focus:bg-[#222222] focus:outline-none';
      li.tabIndex = 0;
      li.setAttribute('role', 'listitem');
      li.textContent = `${tx.type === 'income' ? '+' : '-'}${tx.amount} € - ${tx.description} (${new Date(tx.date).toLocaleDateString()})`;
      const btnDelete = document.createElement('button');
      btnDelete.className = 'text-orange-500 hover:text-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-500 rounded ml-2';
      btnDelete.setAttribute('aria-label', `Eliminar transacción: ${tx.description}`);
      btnDelete.innerHTML = '<i class="fas fa-trash-alt"></i>';
      btnDelete.addEventListener('click', () => {
        state.transactions = state.transactions.filter(t => t.id !== tx.id);
        renderTransactionList();
        updateTransactionTotals();
        saveToStorage();
      });
      li.appendChild(btnDelete);
      transactionList.appendChild(li);
    });
  }

  // Actualizar totales de transacciones
  function updateTransactionTotals() {
    const income = state.transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
    const expense = state.transactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
    totalIncomeEl.textContent = income.toFixed(2);
    totalExpenseEl.textContent = expense.toFixed(2);
  }

  // Agregar nueva transacción
  function addNewTransaction() {
    const type = prompt('Tipo de transacción (income/gasto):').toLowerCase();
    if (type !== 'income' && type !== 'gasto' && type !== 'expense') {
      alert('Tipo inválido. Use "income" o "gasto".');
      return;
    }
    const normalizedType = (type === 'gasto') ? 'expense' : 'income';
    const amountStr = prompt('Cantidad (€):');
    const amount = parseFloat(amountStr);
    if (isNaN(amount) || amount <= 0) {
      alert('Cantidad inválida.');
      return;
    }
    const description = prompt('Descripción:');
    if (!description) {
      alert('Descripción requerida.');
      return;
    }
    const newTx = {
      id: crypto.randomUUID(),
      type: normalizedType,
      amount,
      description,
      date: new Date().toISOString(),
    };
    state.transactions.push(newTx);
    renderTransactionList();
    updateTransactionTotals();
    saveToStorage();
    checkAchievements();
  }

  // Renderizar logros
  function renderAchievements() {
    // Ya están en HTML estático, pero podemos agregar clase para desbloqueados
    const items = achievementsList.querySelectorAll('li');
    items.forEach(li => {
      const label = li.getAttribute('aria-label');
      if (state.achievements.has(label)) {
        li.classList.add('shadow-[0_0_20px_5px_rgba(255,106,0,0.9)]');
      } else {
        li.classList.remove('shadow-[0_0_20px_5px_rgba(255,106,0,0.9)]');
      }
    });
  }

  // Comprobar y actualizar logros
  function checkAchievements() {
    // Primer ingreso registrado
    if (!state.achievements.has('Logro: Primer ingreso registrado')) {
      if (state.transactions.some(t => t.type === 'income')) {
        state.achievements.add('Logro: Primer ingreso registrado');
        playSound('achievement');
        vibrateSim(300);
      }
    }
    // 5 gastos registrados
    if (!state.achievements.has('Logro: 5 gastos registrados')) {
      const gastosCount = state.transactions.filter(t => t.type === 'expense').length;
      if (gastosCount >= 5) {
        state.achievements.add('Logro: 5 gastos registrados');
        playSound('achievement');
        vibrateSim(300);
      }
    }
    // Meta de ahorro alcanzada (simplificado)
    if (!state.achievements.has('Logro: Meta de ahorro alcanzada')) {
      if (state.savingsProjection && state.savingsProjection.months <= 12) {
        state.achievements.add('Logro: Meta de ahorro alcanzada');
        playSound('achievement');
        vibrateSim(300);
      }
    }
    // 10 transacciones registradas
    if (!state.achievements.has('Logro: 10 transacciones registradas')) {
      if (state.transactions.length >= 10) {
        state.achievements.add('Logro: 10 transacciones registradas');
        playSound('achievement');
        vibrateSim(300);
      }
    }
    // Uso diario por 7 días (simplificado)
    // Guardamos fechas de uso en localStorage
    const usageDates = JSON.parse(localStorage.getItem('myhorizon_usage_dates') || '[]');
    const todayStr = new Date().toISOString().slice(0,10);
    if (!usageDates.includes(todayStr)) {
      usageDates.push(todayStr);
      localStorage.setItem('myhorizon_usage_dates', JSON.stringify(usageDates));
    }
    if (!state.achievements.has('Logro: Uso diario por 7 días')) {
      if (usageDates.length >= 7) {
        state.achievements.add('Logro: Uso diario por 7 días');
        playSound('achievement');
        vibrateSim(300);
      }
    }
    // Exportación de datos realizada
    // Se activa en exportConfig()

    renderAchievements();
    saveToStorage();
  }

  // Simulador de metas y proyecciones
  function calculateSavingsProjection(monthlyIncome, monthlySavings, goalAmount) {
    if (monthlySavings <= 0) return null;
    const months = Math.ceil(goalAmount / monthlySavings);
    return { months };
  }
  function updateSavingsProjection(e) {
    e.preventDefault();
    const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value);
    const monthlySavings = parseFloat(document.getElementById('monthlySavings').value);
    const goalAmount = parseFloat(document.getElementById('goalAmount').value);
    if (isNaN(monthlyIncome) || isNaN(monthlySavings) || isNaN(goalAmount) || monthlySavings <= 0 || goalAmount <= 0) {
      savingsProjectionResult.textContent = 'Por favor, ingresa valores válidos.';
      return;
    }
    const projection = calculateSavingsProjection(monthlyIncome, monthlySavings, goalAmount);
    if (!projection) {
      savingsProjectionResult.textContent = 'No se puede calcular la proyección con los datos proporcionados.';
      return;
    }
    state.savingsProjection = projection;
    savingsProjectionResult.textContent = `Con un ahorro mensual de ${monthlySavings} €, alcanzarás tu meta de ${goalAmount} € en aproximadamente ${projection.months} meses.`;
    checkAchievements();
    saveToStorage();
  }

  // Sonidos con Web Audio API
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playSound(type) {
    if (!audioCtx) return;
    let oscillator;
    let gainNode;
    switch(type) {
      case 'alarm':
        oscillator = audioCtx.createOscillator();
        gainNode = audioCtx.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 1);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1);
        oscillator.stop(audioCtx.currentTime + 1);
        break;
      case 'complete':
        oscillator = audioCtx.createOscillator();
        gainNode = audioCtx.createGain();
        oscillator.type = 'triangle';
        oscillator.frequency.setValueAtTime(660, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.3);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
        oscillator.stop(audioCtx.currentTime + 0.3);
        break;
      case 'achievement':
        oscillator = audioCtx.createOscillator();
        gainNode = audioCtx.createGain();
        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.25, audioCtx.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.frequency.setValueAtTime(660, audioCtx.currentTime + 0.2);
        gainNode.gain.setValueAtTime(0, audioCtx.currentTime + 0.5);
        oscillator.stop(audioCtx.currentTime + 0.5);
        break;
      default:
        break;
    }
  }

  // Vibración simulada
  function vibrateSim(duration) {
    if (navigator.vibrate) {
      navigator.vibrate(duration);
    } else {
      // Simulación con temporizador y animación de onda luminosa en body
      document.body.classList.add('wave-light');
      setTimeout(() => {
        document.body.classList.remove('wave-light');
      }, duration);
    }
  }

  // Widget 3D volumétricos (canvas simple con rotación y parallax)
  function initWidget3D() {
    const canvas = widget3DCanvas;
    const ctx = canvas.getContext('2d');
    let width, height;
    let angleX = 0;
    let angleY = 0;
    let lastX = 0;
    let lastY = 0;
    let isDragging = false;

    function resize() {
      width = canvas.clientWidth * devicePixelRatio;
      height = canvas.clientHeight * devicePixelRatio;
      canvas.width = width;
      canvas.height = height;
      ctx.scale(devicePixelRatio, devicePixelRatio);
    }
    function drawCube(cx, cy, size, angleX, angleY) {
      // Simple cube projection
      const sinX = Math.sin(angleX);
      const cosX = Math.cos(angleX);
      const sinY = Math.sin(angleY);
      const cosY = Math.cos(angleY);

      const points = [
        [-1, -1, -1],
        [1, -1, -1],
        [1, 1, -1],
        [-1, 1, -1],
        [-1, -1, 1],
        [1, -1, 1],
        [1, 1, 1],
        [-1, 1, 1],
      ].map(([x, y, z]) => {
        // Rotate X
        let dy = y * cosX - z * sinX;
        let dz = y * sinX + z * cosX;
        y = dy;
        z = dz;
        // Rotate Y
        let dx = x * cosY + z * sinY;
        dz = -x * sinY + z * cosY;
        x = dx;
        z = dz;
        // Perspective projection
        const distance = 3;
        const scale = distance / (distance + z);
        return [cx + x * size * scale, cy + y * size * scale];
      });

      const edges = [
        [0,1],[1,2],[2,3],[3,0],
        [4,5],[5,6],[6,7],[7,4],
        [0,4],[1,5],[2,6],[3,7]
      ];

      ctx.strokeStyle = 'rgba(255,106,0,0.8)';
      ctx.lineWidth = 2;
      ctx.shadowColor = 'rgba(255,106,0,0.7)';
      ctx.shadowBlur = 8;
      edges.forEach(([a,b]) => {
        ctx.beginPath();
        ctx.moveTo(points[a][0], points[a][1]);
        ctx.lineTo(points[b][0], points[b][1]);
        ctx.stroke();
      });
    }

    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawCube(canvas.clientWidth/2, canvas.clientHeight/2, 100, angleX, angleY);
      angleX += 0.005;
      angleY += 0.007;
      requestAnimationFrame(render);
    }

    canvas.addEventListener('mousedown', e => {
      isDragging = true;
      lastX = e.clientX;
      lastY = e.clientY;
    });
    canvas.addEventListener('mouseup', e => {
      isDragging = false;
    });
    canvas.addEventListener('mouseleave', e => {
      isDragging = false;
    });
    canvas.addEventListener('mousemove', e => {
      if (!isDragging) return;
      const dx = e.clientX - lastX;
      const dy = e.clientY - lastY;
      angleY += dx * 0.01;
      angleX += dy * 0.01;
      lastX = e.clientX;
      lastY = e.clientY;
    });
    canvas.addEventListener('touchstart', e => {
      if (e.touches.length === 1) {
        isDragging = true;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
      }
    });
    canvas.addEventListener('touchend', e => {
      isDragging = false;
    });
    canvas.addEventListener('touchmove', e => {
      if (!isDragging || e.touches.length !== 1) return;
      const dx = e.touches[0].clientX - lastX;
      const dy = e.touches[0].clientY - lastY;
      angleY += dx * 0.01;
      angleX += dy * 0.01;
      lastX = e.touches[0].clientX;
      lastY = e.touches[0].clientY;
      e.preventDefault();
    }, { passive: false });

    window.addEventListener('resize', resize);
    resize();
    render();
  }

  // Proyecto 3D (simplificado)
  function initProject3D() {
    const canvas = project3DCanvas;
    const ctx = canvas.getContext('2d');
    let width, height;
    let angle = 0;

    function resize() {
      width = canvas.clientWidth * devicePixelRatio;
      height = canvas.clientHeight * devicePixelRatio;
      canvas.width = width;
      canvas.height = height;
      ctx.scale(devicePixelRatio, devicePixelRatio);
    }

    function drawProjectEcosystem() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const cx = canvas.clientWidth / 2;
      const cy = canvas.clientHeight / 2;
      const radius = 80;
      const projects = state.projects;
      const count = projects.length;
      if (count === 0) {
        ctx.fillStyle = 'rgba(255,106,0,0.3)';
        ctx.font = '16px monospace';
        ctx.textAlign = 'center';
        ctx.fillText('No hay proyectos para mostrar', cx, cy);
        return;
      }
      ctx.strokeStyle = 'rgba(255,106,0,0.7)';
      ctx.lineWidth = 2;
      ctx.shadowColor = 'rgba(255,106,0,0.7)';
      ctx.shadowBlur = 6;

      // Dibujar círculo central
      ctx.beginPath();
      ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
      ctx.stroke();

      // Dibujar proyectos como nodos alrededor
      projects.forEach((proj, i) => {
        const angleNode = (2 * Math.PI / count) * i + angle;
        const x = cx + Math.cos(angleNode) * (radius + 60);
        const y = cy + Math.sin(angleNode) * (radius + 60);
        // Línea al centro
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(x, y);
        ctx.stroke();
        // Nodo
        ctx.beginPath();
        ctx.arc(x, y, 20, 0, 2 * Math.PI);
        ctx.fillStyle = (state.selectedProjectId === proj.id) ? 'rgba(255,140,0,0.9)' : 'rgba(255,106,0,0.6)';
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,140,0,0.9)';
        ctx.stroke();
        // Texto
        ctx.fillStyle = '#121212';
        ctx.font = '12px monospace';
        ctx.textAlign = 'center';
        ctx.fillText(proj.name, x, y + 4);
      });
    }

    function render() {
      drawProjectEcosystem();
      angle += 0.005;
      requestAnimationFrame(render);
    }

    function onClick(e) {
      const rect = canvas.getBoundingClientRect();
      const cx = canvas.clientWidth / 2;
      const cy = canvas.clientHeight / 2;
      const xClick = (e.clientX - rect.left);
      const yClick = (e.clientY - rect.top);
      const radius = 80;
      const projects = state.projects;
      const count = projects.length;
      for (let i = 0; i < count; i++) {
        const angleNode = (2 * Math.PI / count) * i + angle;
        const x = cx + Math.cos(angleNode) * (radius + 60);
        const y = cy + Math.sin(angleNode) * (radius + 60);
        const dx = x - xClick;
        const dy = y - yClick;
        if (Math.sqrt(dx*dx + dy*dy) < 20) {
          state.selectedProjectId = projects[i].id;
          renderProjectList();
          renderProjectDetails();
          saveToStorage();
          break;
        }
      }
    }

    canvas.addEventListener('click', onClick);
    window.addEventListener('resize', resize);
    resize();
    render();
  }

  // MindSphereTR© - dibujo tinta líquida naranja
  function initLiquidInk() {
    const canvas = liquidInkCanvas;
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let lastX = 0;
    let lastY = 0;

    function resize() {
      canvas.width = canvas.clientWidth * devicePixelRatio;
      canvas.height = canvas.clientHeight * devicePixelRatio;
      ctx.scale(devicePixelRatio, devicePixelRatio);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = 'rgba(255,106,0,0.9)';
      ctx.lineWidth = 3;
      ctx.shadowColor = 'rgba(255,106,0,0.7)';
      ctx.shadowBlur = 6;
      if (state.liquidInkImage) {
        const img = new Image();
        img.onload = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.clientWidth, canvas.clientHeight);
        };
        img.src = state.liquidInkImage;
      } else {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    }

    function startDraw(e) {
      drawing = true;
      const rect = canvas.getBoundingClientRect();
      lastX = (e.clientX || e.touches[0].clientX) - rect.left;
      lastY = (e.clientY || e.touches[0].clientY) - rect.top;
    }
    function draw(e) {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX || e.touches[0].clientX) - rect.left;
      const y = (e.clientY || e.touches[0].clientY) - rect.top;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      lastX = x;
      lastY = y;
      e.preventDefault();
    }
    function endDraw() {
      drawing = false;
      saveInkImage();
    }
    function saveInkImage() {
      state.liquidInkImage = canvas.toDataURL();
      saveToStorage();
    }
    function clearInk() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      state.liquidInkImage = null;
      saveToStorage();
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('touchstart', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('touchend', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    clearInkBtn.addEventListener('click', () => {
      clearInk();
    });
    saveInkBtn.addEventListener('click', () => {
      saveInkImage();
      alert('Dibujo guardado localmente.');
    });

    window.addEventListener('resize', resize);
    resize();
  }

  // MindSphereTR© - mapas conceptuales (canvas con nodos y conexiones animadas)
  function initConceptMap() {
    const canvas = conceptMapCanvas;
    const ctx = canvas.getContext('2d');
    let width, height;
    let nodes = [];
    let connections = [];
    let draggingNode = null;
    let offsetX = 0;
    let offsetY = 0;

    function resize() {
      width = canvas.clientWidth * devicePixelRatio;
      height = canvas.clientHeight * devicePixelRatio;
      canvas.width = width;
      canvas.height = height;
      ctx.scale(devicePixelRatio, devicePixelRatio);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Fondo sutil animado
      const gradient = ctx.createLinearGradient(0, 0, width, height);
      gradient.addColorStop(0, 'rgba(255,106,0,0.05)');
      gradient.addColorStop(1, 'rgba(255,106,0,0.15)');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.clientWidth, canvas.clientHeight);

      // Conexiones animadas
      ctx.strokeStyle = 'rgba(255,106,0,0.7)';
      ctx.lineWidth = 2;
      ctx.shadowColor = 'rgba(255,106,0,0.7)';
      ctx.shadowBlur = 6;
      connections.forEach(conn => {
        const from = nodes.find(n => n.id === conn.from);
        const to = nodes.find(n => n.id === conn.to);
        if (!from || !to) return;
        ctx.beginPath();
        ctx.moveTo(from.x, from.y);
        // Curva Bezier animada
        const cpX = (from.x + to.x) / 2 + Math.sin(Date.now() / 500) * 10;
        const cpY = (from.y + to.y) / 2 + Math.cos(Date.now() / 500) * 10;
        ctx.quadraticCurveTo(cpX, cpY, to.x, to.y);
        ctx.stroke();
      });

      // Nodos
      nodes.forEach(node => {
        ctx.beginPath();
        ctx.fillStyle = 'rgba(255,106,0,0.9)';
        ctx.shadowColor = 'rgba(255,106,0,0.9)';
        ctx.shadowBlur = 8;
        ctx.arc(node.x, node.y, 20, 0, 2 * Math.PI);
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.fillStyle = '#121212';
        ctx.font = '12px monospace';
        ctx.textAlign = 'center';
        ctx.fillText(node.label, node.x, node.y + 4);
      });

      requestAnimationFrame(draw);
    }

    function addNode(x, y, label) {
      const id = crypto.randomUUID();
      nodes.push({ id, x, y, label });
      saveConceptMap();
    }
    function addConnection(fromId, toId) {
      connections.push({ from: fromId, to: toId });
      saveConceptMap();
    }
    function saveConceptMap() {
      state.conceptMap = { nodes, connections };
      saveToStorage();
    }
    function loadConceptMap() {
      if (state.conceptMap) {
        nodes = state.conceptMap.nodes || [];
        connections = state.conceptMap.connections || [];
      }
    }

    function getNodeAt(x, y) {
      return nodes.find(n => Math.hypot(n.x - x, n.y - y) < 20);
    }

    let lastClickNode = null;

    canvas.addEventListener('mousedown', e => {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left);
      const y = (e.clientY - rect.top);
      const node = getNodeAt(x, y);
      if (node) {
        draggingNode = node;
        offsetX = x - node.x;
        offsetY = y - node.y;
      } else {
        const label = prompt('Etiqueta para nuevo nodo:');
        if (label) {
          addNode(x, y, label);
        }
      }
    });
    canvas.addEventListener('mousemove', e => {
      if (!draggingNode) return;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left);
      const y = (e.clientY - rect.top);
      draggingNode.x = x - offsetX;
      draggingNode.y = y - offsetY;
      saveConceptMap();
    });
    canvas.addEventListener('mouseup', e => {
      if (draggingNode) {
        draggingNode = null;
      } else {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left);
        const y = (e.clientY - rect.top);
        const node = getNodeAt(x, y);
        if (node) {
          if (lastClickNode && lastClickNode !== node) {
            addConnection(lastClickNode.id, node.id);
            lastClickNode = null;
          } else {
            lastClickNode = node;
          }
        } else {
          lastClickNode = null;
        }
      }
    });
    canvas.addEventListener('mouseleave', e => {
      draggingNode = null;
    });

    loadConceptMap();
    resize();
    draw();
    window.addEventListener('resize', resize);
  }

  // Buscador interno MindSphereTR©
  function searchMindSphere(query) {
    const results = [];
    if (!query) return results;
    const q = query.toLowerCase();
    // Buscar en notas de texto
    if (state.mindTextNotes && state.mindTextNotes.toLowerCase().includes(q)) {
      results.push({ type: 'Nota de texto', content: state.mindTextNotes });
    }
    // Buscar en notas rápidas
    if (state.quickNotes && state.quickNotes.toLowerCase().includes(q)) {
      results.push({ type: 'Nota rápida', content: state.quickNotes });
    }
    // Buscar en nodos de mapas conceptuales
    if (state.conceptMap && state.conceptMap.nodes) {
      state.conceptMap.nodes.forEach(node => {
        if (node.label.toLowerCase().includes(q)) {
          results.push({ type: 'Nodo mapa conceptual', content: node.label });
        }
      });
    }
    return results;
  }
  function updateMindSearchResults() {
    const query = mindSearchInput.value.trim();
    const results = searchMindSphere(query);
    mindSearchResults.innerHTML = '';
    if (results.length === 0) {
      const li = document.createElement('li');
      li.textContent = 'No se encontraron resultados.';
      li.className = 'italic select-none';
      mindSearchResults.appendChild(li);
      return;
    }
    results.forEach(res => {
      const li = document.createElement('li');
      li.className = 'p-1 hover:bg-[#222222] rounded cursor-pointer';
      li.tabIndex = 0;
      li.textContent = `[${res.type}] ${res.content}`;
      mindSearchResults.appendChild(li);
    });
  }

  // Guardar notas de texto MindSphereTR©
  function saveMindTextNotes() {
    state.mindTextNotes = mindTextNotesTextarea.value;
    saveToStorage();
    showTempMessage(saveMindTextBtn, 'Guardado');
  }

  // Guardar perfil
  function saveProfile() {
    state.username = usernameInput.value.trim();
    saveToStorage();
    showTempMessage(saveProfileBtn, 'Guardado');
  }

  // Eventos
  openSidePanelBtn.addEventListener('click', openSidePanel);
  closeSidePanelBtn.addEventListener('click', closeSidePanel);

  toggleThemeBtn.addEventListener('click', () => {
    state.themeAuto = !state.themeAuto;
    toggleThemeBtn.textContent = state.themeAuto ? 'Modo Automático' : 'Modo Manual';
    toggleThemeBtn.setAttribute('aria-pressed', state.themeAuto.toString());
    applyTheme();
    saveToStorage();
  });

  freqRange.addEventListener('input', () => {
    freqValue.textContent = freqRange.value;
    state.assistantConfig.frequency = parseInt(freqRange.value, 10);
    saveToStorage();
  });
  styleSelect.addEventListener('change', () => {
    state.assistantConfig.style = styleSelect.value;
    saveToStorage();
  });

  saveProfileBtn.addEventListener('click', saveProfile);

  exportConfigBtn.addEventListener('click', () => {
    exportConfig();
    state.achievements.add('Logro: Exportación de datos realizada');
    renderAchievements();
  });

  importConfigBtn.addEventListener('click', () => {
    importConfigInput.click();
  });
  importConfigInput.addEventListener('change', e => {
    if (e.target.files.length > 0) {
      importConfig(e.target.files[0]);
    }
  });

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      switchTab(btn.dataset.tab);
    });
  });
  tabButtonsMobile.forEach(btn => {
    btn.addEventListener('click', () => {
      switchTab(btn.dataset.tab);
    });
  });

  mobileMenuBtn.addEventListener('click', () => {
    if (mobileNav.classList.contains('hidden')) {
      mobileNav.classList.remove('hidden');
      mobileNav.classList.add('block');
    } else {
      mobileNav.classList.remove('block');
      mobileNav.classList.add('hidden');
    }
  });

  pomodoroStart.addEventListener('click', () => {
    startPomodoro();
    saveToStorage();
  });
  pomodoroPause.addEventListener('click', () => {
    pausePomodoro();
    saveToStorage();
  });
  pomodoroReset.addEventListener('click', () => {
    resetPomodoro();
    saveToStorage();
  });

  saveQuickNotesBtn.addEventListener('click', saveQuickNotes);

  assistantSuggestBtn.addEventListener('click', () => {
    addAssistantSuggestion();
  });
  assistantClearBtn.addEventListener('click', clearAssistantSuggestions);

  addProjectBtn.addEventListener('click', addNewProject);

  saveMindTextBtn.addEventListener('click', saveMindTextNotes);

  mindSearchInput.addEventListener('input', updateMindSearchResults);

  addTransactionBtn.addEventListener('click', addNewTransaction);

  savingsSimulatorForm.addEventListener('submit', updateSavingsProjection);

  // Inicialización
  function init() {
    loadFromStorage();
    applyTheme();
    loadAllDataToUI();
    updateWorldClocks();
    setInterval(updateWorldClocks, 1000);
    updateLunarCalendar();
    setInterval(updateLunarCalendar, 60000);
    initWidget3D();
    initProject3D();
    initLiquidInk();
    initConceptMap();
    checkAchievements();
    switchTab('dashboard');
  }

  init();

})();
   </script>
  </main>
 </body>
</html>
